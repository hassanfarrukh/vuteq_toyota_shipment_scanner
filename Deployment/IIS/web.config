<?xml version="1.0" encoding="UTF-8"?>
<!--
============================================================================
VUTEQ Scanner - IIS Reverse Proxy Configuration
Author: Hassan
Date: 2026-01-07
Description: Simple reverse proxy routing /api/* to backend:5000, everything else to frontend:3000
============================================================================
-->
<configuration>
  <system.webServer>
    <!-- URL Rewrite Rules for Reverse Proxy -->
    <rewrite>
      <rules>
        <!-- Rule 1: API Backend Proxy -->
        <rule name="API Reverse Proxy" stopProcessing="true">
          <match url="^api/(.*)" />
          <conditions>
            <add input="{REQUEST_FILENAME}" matchType="IsFile" negate="true" />
            <add input="{REQUEST_FILENAME}" matchType="IsDirectory" negate="true" />
          </conditions>
          <action type="Rewrite" url="http://localhost:5000/api/{R:1}" />
          <serverVariables>
            <set name="HTTP_X_ORIGINAL_HOST" value="{HTTP_HOST}" />
            <set name="HTTP_X_FORWARDED_FOR" value="{REMOTE_ADDR}" />
            <set name="HTTP_X_FORWARDED_PROTO" value="{REQUEST_SCHEME}" />
          </serverVariables>
        </rule>

        <!-- Rule 2: Frontend Static Resources -->
        <rule name="Frontend Static Files" stopProcessing="true">
          <match url="^(_next|static|images|favicon\.ico|robots\.txt|sitemap\.xml)(.*)" />
          <action type="Rewrite" url="http://localhost:3000/{R:0}" />
          <serverVariables>
            <set name="HTTP_X_ORIGINAL_HOST" value="{HTTP_HOST}" />
          </serverVariables>
        </rule>

        <!-- Rule 3: Frontend Next.js Data -->
        <rule name="Frontend Next Data" stopProcessing="true">
          <match url="^_next/data/(.*)" />
          <action type="Rewrite" url="http://localhost:3000/_next/data/{R:1}" />
          <serverVariables>
            <set name="HTTP_X_ORIGINAL_HOST" value="{HTTP_HOST}" />
          </serverVariables>
        </rule>

        <!-- Rule 4: Frontend Webpack HMR (Development) -->
        <rule name="Frontend HMR" stopProcessing="true">
          <match url="^_next/webpack-hmr" />
          <action type="Rewrite" url="http://localhost:3000/_next/webpack-hmr" />
        </rule>

        <!-- Rule 5: Frontend All Other Requests -->
        <rule name="Frontend Reverse Proxy" stopProcessing="true">
          <match url="(.*)" />
          <conditions>
            <add input="{REQUEST_URI}" pattern="^/api/" negate="true" />
            <add input="{REQUEST_FILENAME}" matchType="IsFile" negate="true" />
            <add input="{REQUEST_FILENAME}" matchType="IsDirectory" negate="true" />
          </conditions>
          <action type="Rewrite" url="http://localhost:3000/{R:1}" />
          <serverVariables>
            <set name="HTTP_X_ORIGINAL_HOST" value="{HTTP_HOST}" />
            <set name="HTTP_X_FORWARDED_FOR" value="{REMOTE_ADDR}" />
            <set name="HTTP_X_FORWARDED_PROTO" value="{REQUEST_SCHEME}" />
          </serverVariables>
        </rule>
      </rules>

    </rewrite>
  </system.webServer>
</configuration>
