<?xml version="1.0" encoding="UTF-8"?>
<!--
============================================================================
VUTEQ Scanner - IIS URL Rewrite Configuration
Author: Hassan
Date: 2026-01-07
Description: Reverse proxy configuration for routing requests to backend/frontend
============================================================================
-->
<configuration>
  <system.webServer>
    <!-- ASP.NET Core Module Configuration -->
    <handlers>
      <add name="aspNetCore" path="*" verb="*" modules="AspNetCoreModuleV2" resourceType="Unspecified" />
    </handlers>

    <aspNetCore processPath="dotnet"
                arguments=".\VuteqScanner.dll"
                stdoutLogEnabled="true"
                stdoutLogFile=".\logs\stdout"
                hostingModel="inprocess">
      <environmentVariables>
        <environmentVariable name="ASPNETCORE_ENVIRONMENT" value="Production" />
        <environmentVariable name="ASPNETCORE_URLS" value="http://localhost:5000" />
      </environmentVariables>
    </aspNetCore>

    <!-- URL Rewrite Rules for Reverse Proxy -->
    <rewrite>
      <rules>
        <!-- Rule 1: API Backend Proxy -->
        <rule name="API Reverse Proxy" stopProcessing="true">
          <match url="^api/(.*)" />
          <conditions>
            <add input="{REQUEST_FILENAME}" matchType="IsFile" negate="true" />
            <add input="{REQUEST_FILENAME}" matchType="IsDirectory" negate="true" />
          </conditions>
          <action type="Rewrite" url="http://localhost:5000/api/{R:1}" />
          <serverVariables>
            <set name="HTTP_X_ORIGINAL_HOST" value="{HTTP_HOST}" />
            <set name="HTTP_X_FORWARDED_FOR" value="{REMOTE_ADDR}" />
            <set name="HTTP_X_FORWARDED_PROTO" value="{REQUEST_SCHEME}" />
          </serverVariables>
        </rule>

        <!-- Rule 2: Frontend Static Resources -->
        <rule name="Frontend Static Files" stopProcessing="true">
          <match url="^(_next|static|images|favicon\.ico|robots\.txt|sitemap\.xml)(.*)" />
          <action type="Rewrite" url="http://localhost:3000/{R:0}" />
          <serverVariables>
            <set name="HTTP_X_ORIGINAL_HOST" value="{HTTP_HOST}" />
          </serverVariables>
        </rule>

        <!-- Rule 3: Frontend Next.js Data -->
        <rule name="Frontend Next Data" stopProcessing="true">
          <match url="^_next/data/(.*)" />
          <action type="Rewrite" url="http://localhost:3000/_next/data/{R:1}" />
          <serverVariables>
            <set name="HTTP_X_ORIGINAL_HOST" value="{HTTP_HOST}" />
          </serverVariables>
        </rule>

        <!-- Rule 4: Frontend Webpack HMR (Development) -->
        <rule name="Frontend HMR" stopProcessing="true">
          <match url="^_next/webpack-hmr" />
          <action type="Rewrite" url="http://localhost:3000/_next/webpack-hmr" />
        </rule>

        <!-- Rule 5: Frontend All Other Requests -->
        <rule name="Frontend Reverse Proxy" stopProcessing="true">
          <match url="(.*)" />
          <conditions>
            <add input="{REQUEST_URI}" pattern="^/api/" negate="true" />
            <add input="{REQUEST_FILENAME}" matchType="IsFile" negate="true" />
            <add input="{REQUEST_FILENAME}" matchType="IsDirectory" negate="true" />
          </conditions>
          <action type="Rewrite" url="http://localhost:3000/{R:1}" />
          <serverVariables>
            <set name="HTTP_X_ORIGINAL_HOST" value="{HTTP_HOST}" />
            <set name="HTTP_X_FORWARDED_FOR" value="{REMOTE_ADDR}" />
            <set name="HTTP_X_FORWARDED_PROTO" value="{REQUEST_SCHEME}" />
          </serverVariables>
        </rule>
      </rules>

      <!-- Outbound Rules for Security Headers -->
      <outboundRules>
        <rule name="Add HSTS Header" preCondition="HTTPS">
          <match serverVariable="RESPONSE_Strict-Transport-Security" pattern=".*" />
          <action type="Rewrite" value="max-age=31536000; includeSubDomains; preload" />
        </rule>
        <rule name="Add X-Content-Type-Options">
          <match serverVariable="RESPONSE_X-Content-Type-Options" pattern=".*" />
          <action type="Rewrite" value="nosniff" />
        </rule>
        <rule name="Add X-Frame-Options">
          <match serverVariable="RESPONSE_X-Frame-Options" pattern=".*" />
          <action type="Rewrite" value="SAMEORIGIN" />
        </rule>
        <preConditions>
          <preCondition name="HTTPS">
            <add input="{HTTPS}" pattern="on" />
          </preCondition>
        </preConditions>
      </outboundRules>
    </rewrite>

    <!-- Error Handling -->
    <httpErrors errorMode="Detailed" />

    <!-- Security Settings -->
    <security>
      <requestFiltering>
        <!-- Allow up to 100MB uploads -->
        <requestLimits maxAllowedContentLength="104857600" />
      </requestFiltering>
    </security>

    <!-- Static Content Compression -->
    <urlCompression doStaticCompression="true" doDynamicCompression="true" />

    <!-- Static Content Caching -->
    <staticContent>
      <clientCache cacheControlMode="UseMaxAge" cacheControlMaxAge="7.00:00:00" />
    </staticContent>

    <!-- Custom Headers -->
    <httpProtocol>
      <customHeaders>
        <remove name="X-Powered-By" />
        <add name="X-Content-Type-Options" value="nosniff" />
        <add name="X-Frame-Options" value="SAMEORIGIN" />
        <add name="Referrer-Policy" value="strict-origin-when-cross-origin" />
      </customHeaders>
    </httpProtocol>
  </system.webServer>
</configuration>
