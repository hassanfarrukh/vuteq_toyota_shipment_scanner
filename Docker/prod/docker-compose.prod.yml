# Author: Hassan
# Date: 2026-01-07
# Production Docker Compose for VUTEQ Scanner
# SQL Server runs on Windows host (NOT in Docker)

version: '3.8'

services:
  # ASP.NET Core API Backend
  api:
    build:
      context: ../../../..
      dockerfile: FromHassan/Codes/Docker/prod/Dockerfiles/Dockerfile.api
    container_name: vuteq-api-prod
    restart: unless-stopped
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:5000
      - ConnectionStrings__DefaultConnection=Server=host.docker.internal,1433;Database=VUTEQ_Scanner;User Id=VuteqApp;Password=Vuteq@Prod@2026@CoffeCup!!;TrustServerCertificate=True;MultipleActiveResultSets=true
      - JwtSettings__Secret=VuteqProdSecretKey2026!MinLength32CharsSecure!
      - JwtSettings__Issuer=VuteqScanner
      - JwtSettings__Audience=VuteqScannerUsers
      - JwtSettings__ExpiryMinutes=60
    extra_hosts:
      - "host.docker.internal:host-gateway"
    expose:
      - "5000"
    networks:
      - vuteq-prod-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    depends_on:
      - nginx

  # Next.js Frontend
  frontend:
    build:
      context: ../../../..
      dockerfile: FromHassan/Codes/Docker/prod/Dockerfiles/Dockerfile.nextjs
    container_name: vuteq-frontend-prod
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_API_URL=http://localhost/api
      - PORT=3000
    expose:
      - "3000"
    networks:
      - vuteq-prod-network
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/api/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    depends_on:
      - api

  # Nginx Reverse Proxy
  nginx:
    image: nginx:alpine
    container_name: vuteq-nginx-prod
    restart: unless-stopped
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    networks:
      - vuteq-prod-network
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    depends_on:
      - api
      - frontend

networks:
  vuteq-prod-network:
    driver: bridge

volumes:
  api-logs:
  nginx-logs:
